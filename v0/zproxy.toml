[global]
workers = 0
log_level = "info"
io_uring_sq_depth = 4096
io_uring_buf_count = 1024
io_uring_buf_size = 32768

[[server]]
bind = "0.0.0.0"
port = 8080
backlog = 4096
server_name = ["example.com", "www.example.com"]

[server.timeouts]
connect_ms = 2000
read_ms = 30000
write_ms = 30000
keepalive_ms = 75000

[[server.upstream_pool]]
name = "api"
strategy = "round_robin"
pool_size = 64

[[server.upstream_pool.upstream]]
addr = "127.0.0.1:3000"
weight = 10
max_conns = 200

[[server.upstream_pool.upstream]]
addr = "127.0.0.1:3001"
weight = 10
max_conns = 200

[server.upstream_pool.health_check]
enabled = true
interval_ms = 5000
timeout_ms = 2000
path = "/health"

[[server.upstream_pool]]
name = "static-backend"
strategy = "round_robin"
pool_size = 16

[[server.upstream_pool.upstream]]
addr = "127.0.0.1:4000"

[[server.location]]
match = "/api/"
match_type = "prefix"
upstream_pool = "api"

[server.location.rate_limit]
requests_per_second = 100
burst = 200
strategy = "token_bucket"

[[server.location.add_request_header]]
name = "X-Forwarded-For"
value = "$remote_addr"

[[server.location.add_request_header]]
name = "X-Real-IP"
value = "$remote_addr"

[[server.location.add_request_header]]
name = "X-Request-ID"
value = "$request_id"

[[server.location.remove_request_header]]
name = "X-Internal-Token"

[[server.location.add_response_header]]
name = "X-Proxy"
value = "zproxy"

[[server.location.add_response_header]]
name = "X-Request-ID"
value = "$request_id"

[[server.location.remove_response_header]]
name = "Server"

[[server.location.remove_response_header]]
name = "X-Powered-By"

[[server.location]]
match = "/static/"
match_type = "prefix"
upstream_pool = "static-backend"

[server.location.static]
root = "/var/www/html"
fallback = true

[[server.location]]
match = "/health"
match_type = "exact"
upstream_pool = "api"

[[server.location]]
match = "/"
match_type = "prefix"
upstream_pool = "api"

[[server.location.add_request_header]]
name = "X-Forwarded-For"
value = "$remote_addr"

[[server.location.remove_response_header]]
name = "Server"

[[server]]
bind = "127.0.0.1"
port = 9090
backlog = 128
server_name = ["admin.internal"]

[[server.upstream_pool]]
name = "admin"
strategy = "round_robin"
pool_size = 4

[[server.upstream_pool.upstream]]
addr = "127.0.0.1:9000"

[[server.location]]
match = "/"
match_type = "prefix"
upstream_pool = "admin"

[server.location.rate_limit]
requests_per_second = 10
burst = 20

[server.timeouts]
connect_ms = 1000
read_ms = 10000
write_ms = 10000
keepalive_ms = 30000
